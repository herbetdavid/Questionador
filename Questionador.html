<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Interativo de Questionários</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f5f5f0; }
        .nav-button { transition: all 0.3s ease; }
        .nav-button.active { background-color: #008080; color: white; }
        .nav-button:hover:not(.active) { background-color: #e0e0d1; }
        .content-section { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 20px; margin-top: 20px; }
        .form-input, .form-select, .form-textarea {
            border: 1px solid #cccccc; padding: 10px; border-radius: 6px; width: 100%;
            margin-top: 5px; margin-bottom: 10px; box-sizing: border-box;
        }
        .btn {
            background-color: #008080; color: white; padding: 10px 20px;
            border-radius: 6px; text-align: center; cursor: pointer; transition: background-color 0.3s ease;
            display: inline-block; border: none;
        }
        .btn:hover { background-color: #006666; }
        .btn-secondary { background-color: #a9a9a9; }
        .btn-secondary:hover { background-color: #8c8c8c; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #008080; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #006666; }

        input[type="radio"], input[type="checkbox"] {
            accent-color: #008080;
            margin-right: 8px;
            transform: scale(1.2);
        }
        label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 max-w-6xl">
        <header class="bg-white shadow-md rounded-lg p-6 mb-6">
            <h1 class="text-4xl font-bold text-center text-[#008080]">Sistema Interativo de Questionários</h1>
        </header>

        <nav class="bg-white shadow-md rounded-lg p-4 mb-6 flex justify-center space-x-2 md:space-x-4">
            <button id="navQuestionario" class="nav-button px-4 py-2 md:px-6 md:py-3 rounded-md font-semibold text-sm md:text-base active">Questionário</button>
            <button id="navGerenciar" class="nav-button px-4 py-2 md:px-6 md:py-3 rounded-md font-semibold text-sm md:text-base">Gerenciar Conteúdo</button>
            <button id="navEstatisticas" class="nav-button px-4 py-2 md:px-6 md:py-3 rounded-md font-semibold text-sm md:text-base">Estatísticas</button>
        </nav>

        <main id="mainContent">
            <section id="sectionQuestionario" class="content-section">
                <h2 class="text-2xl font-semibold mb-4 text-[#006666]">Iniciar Novo Questionário</h2>
                <p class="mb-6 text-gray-700">
                    Bem-vindo à seção de questionários! Aqui você pode testar seus conhecimentos selecionando uma banca examinadora,
                    os temas de seu interesse, ou escolher um modelo de prova predefinido.
                </p>

                <div id="quizSetup">
                    <div class="mb-4">
                        <label for="selectModeloProva" class="block text-lg font-medium text-gray-700 mb-1">Selecione um Modelo de Prova (Opcional):</label>
                        <select id="selectModeloProva" class="form-select"></select>
                    </div>
                    <div class="mb-4">
                        <label for="selectBanca" class="block text-lg font-medium text-gray-700 mb-1">Ou selecione a Banca:</label>
                        <select id="selectBanca" class="form-select"></select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-lg font-medium text-gray-700 mb-1">Selecione os Temas:</label>
                        <div id="temasCheckboxContainer" class="max-h-40 overflow-y-auto custom-scrollbar border p-3 rounded-md">
                            <p class="text-gray-500">Selecione uma banca para ver os temas disponíveis.</p>
                        </div>
                    </div>
                    <button id="btnIniciarQuiz" class="btn mt-4">Iniciar Questionário</button>
                </div>

                <div id="quizArea" class="hidden">
                    <p id="progressLabel" class="text-lg font-medium mb-2"></p>
                    <p id="questionText" class="text-xl font-semibold mb-4 p-4 bg-gray-100 rounded-md"></p>
                    <div id="optionsContainer" class="space-y-3 mb-4"></div>
                    <p id="feedbackText" class="text-lg font-medium my-3"></p>
                    <button id="btnConfirmarResposta" class="btn">Confirmar Resposta</button>
                    <button id="btnProximaQuestao" class="btn btn-secondary ml-2 hidden">Próxima Questão</button>
                </div>

                <div id="quizResults" class="hidden mt-6">
                    <h3 class="text-xl font-semibold mb-3 text-[#006666]">Resultado do Questionário</h3>
                    <p id="resultadoFinalTexto" class="text-lg"></p>
                    <button id="btnNovoQuestionario" class="btn mt-4">Fazer Novo Questionário</button>
                </div>
            </section>

            <section id="sectionGerenciar" class="content-section hidden">
                <h2 class="text-2xl font-semibold mb-4 text-[#006666]">Gerenciar Conteúdo</h2>
                <p class="mb-6 text-gray-700">
                    Nesta seção, você pode administrar o banco de dados do sistema: gerencie bancas, disciplinas,
                    modelos de prova, e adicione perguntas manualmente ou via CSV.
                </p>

                <div class="space-y-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-700 border-b pb-2">Gerenciar Bancas</h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-medium mb-2">Adicionar Nova Banca</h4>
                                <label for="novaBancaNome" class="block text-sm font-medium text-gray-700 mb-1">Nome da Banca:</label>
                                <input type="text" id="novaBancaNome" class="form-input" placeholder="Ex: CEBRASPE">
                                <label for="novaBancaNumOpcoes" class="block text-sm font-medium text-gray-700 mb-1">Número de Opções:</label>
                                <input type="number" id="novaBancaNumOpcoes" class="form-input" min="2" max="10" value="5">
                                <label for="novaBancaDescricao" class="block text-sm font-medium text-gray-700 mb-1">Descrição (Opcional):</label>
                                <input type="text" id="novaBancaDescricao" class="form-input" placeholder="Ex: Banca de Certo/Errado">
                                <div class="mt-3">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="novaBancaPenaliza" class="form-checkbox">
                                        <span class="ml-2 text-sm text-gray-700">Penaliza resposta errada?</span>
                                    </label>
                                </div>
                                <button id="btnAdicionarBanca" class="btn mt-4">Adicionar Banca</button>
                            </div>
                            <div>
                                <h4 class="text-lg font-medium mb-2">Bancas Cadastradas</h4>
                                <ul id="listaBancas" class="list-disc pl-5 max-h-48 overflow-y-auto custom-scrollbar border p-3 rounded-md bg-gray-50">
                                    <li class="text-gray-500">Nenhuma banca cadastrada ou carregando...</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-700 border-b pb-2">Gerenciar Disciplinas</h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-medium mb-2">Adicionar Nova Disciplina</h4>
                                <label for="novaDisciplinaNome" class="block text-sm font-medium text-gray-700 mb-1">Nome da Disciplina:</label>
                                <input type="text" id="novaDisciplinaNome" class="form-input" placeholder="Ex: Matemática">
                                <label for="novaDisciplinaDescricao" class="block text-sm font-medium text-gray-700 mb-1">Descrição (Opcional):</label>
                                <input type="text" id="novaDisciplinaDescricao" class="form-input" placeholder="Ex: Raciocínio Lógico e Quantitativo">
                                <button id="btnAdicionarDisciplina" class="btn mt-4">Adicionar Disciplina</button>
                            </div>
                            <div>
                                <h4 class="text-lg font-medium mb-2">Disciplinas Cadastradas</h4>
                                <ul id="listaDisciplinas" class="list-disc pl-5 max-h-48 overflow-y-auto custom-scrollbar border p-3 rounded-md bg-gray-50">
                                    <li class="text-gray-500">Nenhuma disciplina cadastrada ou carregando...</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-700 border-b pb-2">Gerenciar Modelos de Prova</h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-medium mb-2">Adicionar Novo Modelo</h4>
                                <label for="novoModeloNome" class="block text-sm font-medium text-gray-700 mb-1">Nome do Modelo:</label>
                                <input type="text" id="novoModeloNome" class="form-input" placeholder="Ex: Simulado Básico CEBRASPE">

                                <label for="selectModeloBanca" class="block text-sm font-medium text-gray-700 mb-1">Banca do Modelo:</label>
                                <select id="selectModeloBanca" class="form-select"></select>

                                <label class="block text-sm font-medium text-gray-700 mb-1 mt-3">Temas do Modelo:</label>
                                <div id="modelosTemasCheckboxContainer" class="max-h-40 overflow-y-auto custom-scrollbar border p-3 rounded-md bg-gray-50">
                                    <p class="text-gray-500">Selecione uma banca para ver os temas disponíveis.</p>
                                </div>
                                <button id="btnSalvarModeloProva" class="btn mt-4">Salvar Modelo de Prova</button>
                            </div>
                            <div>
                                <h4 class="text-lg font-medium mb-2">Modelos de Prova Cadastrados</h4>
                                <ul id="listaModelosProvas" class="list-disc pl-5 max-h-48 overflow-y-auto custom-scrollbar border p-3 rounded-md bg-gray-50">
                                    <li class="text-gray-500">Nenhum modelo cadastrado ou carregando...</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-700 border-b pb-2">Adicionar Pergunta Manualmente</h3>
                        <label for="manualBancaSelect" class="block text-sm font-medium text-gray-700 mb-1">Banca:</label>
                        <select id="manualBancaSelect" class="form-select mb-2"></select>
                        <label for="manualDisciplinaSelect" class="block text-sm font-medium text-gray-700 mb-1">Disciplina:</label>
                        <select id="manualDisciplinaSelect" class="form-select mb-2"></select> <label for="manualTema" class="block text-sm font-medium text-gray-700 mb-1">Tema:</label>
                        <input type="text" id="manualTema" class="form-input mb-2">
                        <label for="manualPergunta" class="block text-sm font-medium text-gray-700 mb-1">Pergunta:</label>
                        <textarea id="manualPergunta" class="form-textarea mb-2" rows="3"></textarea>
                        <div id="manualOpcoesContainer" class="mb-2"></div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Opção Correta:</label>
                        <div id="manualOpcaoCorretaContainer" class="mb-4"></div>
                        <button id="btnSalvarPerguntaManual" class="btn">Salvar Pergunta</button>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-700 border-b pb-2">Importar Perguntas via CSV</h3>
                        <p class="text-sm text-gray-600 mb-2">
                            Selecione um arquivo CSV. Formato esperado: `banca,disciplina,tema,pergunta,opcao1,opcao2,...,opcaoN,correta` (índice 0-based para correta).
                            O número de colunas 'opcaoX' deve corresponder ao configurado para a banca. Disciplinas e Temas serão adicionados automaticamente se não existirem.
                        </p>
                        <input type="file" id="csvFileInput" accept=".csv" class="form-input mb-2">
                        <button id="btnImportarCSV" class="btn">Importar CSV</button>
                        <p id="csvImportStatus" class="text-sm mt-2"></p>
                    </div>
                </div>
            </section>

            <section id="sectionEstatisticas" class="content-section hidden">
                <h2 class="text-2xl font-semibold mb-4 text-[#006666]">Estatísticas de Desempenho</h2>
                <p class="mb-6 text-gray-700">
                    Acompanhe seu progresso! Esta seção apresenta um resumo do seu desempenho geral,
                    um detalhamento por disciplina e identifica as áreas que podem precisar de mais atenção nos seus estudos.
                </p>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">Desempenho Geral</h3>
                        <p id="statsTotalPerguntas" class="text-lg">Total de Perguntas Respondidas: 0</p>
                        <p id="statsTotalAcertos" class="text-lg">Total de Acertos: 0</p>
                        <p id="statsTotalErros" class="text-lg">Total de Erros: 0</p>
                        <p id="statsPorcentagemGeral" class="text-lg font-bold">Porcentagem Geral de Acertos: 0.00%</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">Acertos / (Acertos + Erros)</h3>
                        <div class="chart-container h-48 max-h-64">
                            <canvas id="overallAccuracyChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">Disciplinas que Carecem de Estudo</h3>
                        <ul id="listaDisciplinasEstudo" class="list-disc pl-5 max-h-48 overflow-y-auto custom-scrollbar">
                            <li class="text-gray-500">Nenhum dado disponível.</li>
                        </ul>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">Conteúdos que Mais Precisam de Prática</h3>
                        <ul id="listaTemasEstudo" class="list-disc pl-5 max-h-48 overflow-y-auto custom-scrollbar">
                            <li class="text-gray-500">Nenhum dado disponível.</li>
                        </ul>
                    </div>
                </div>
                <div class="mt-8 grid md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">Desempenho por Disciplina</h3>
                        <div class="chart-container">
                            <canvas id="desempenhoDisciplinaChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">Conteúdos Mais Praticados</h3>
                        <div class="chart-container">
                            <canvas id="mostPracticedThemesChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center text-sm text-gray-500 mt-10 py-4 border-t">
            Sistema Interativo de Questionários &copy; <span id="currentYear"></span>.
        </footer>
    </div>

    <script>
        let appData = {
            bancas: {
                "CEBRASPE": { num_opcoes: 2, descricao: "Banca CEBRASPE (Certo/Errado)", penaliza_erro: true },
                "FCC": { num_opcoes: 5, descricao: "Banca FCC (Múltipla Escolha)", penaliza_erro: false }
            },
            disciplinas: { // NEW: Explicitly store disciplines
                "Matemática": { descricao: "Estudos de números e quantidades." },
                "Português": { descricao: "Estudos da língua portuguesa." },
                "Direito Constitucional": { descricao: "Estudos da Constituição Federal." },
                "Informática": { descricao: "Estudos de hardware e software." }
            },
            modelosProvas: { // NEW: Store quiz presets
                "Simulado CEBRASPE Básico": { banca: "CEBRASPE", temas: ["Álgebra", "Gramática"] },
                "FCC Fundamentos": { banca: "FCC", temas: ["Interpretação de Texto", "Direitos Fundamentais"] }
            },
            perguntas: [
                { banca: "CEBRASPE", disciplina: "Matemática", tema: "Álgebra", pergunta: "A soma de dois números pares é sempre par.", opcoes: ["Certo", "Errado"], correta: 0 },
                { banca: "CEBRASPE", disciplina: "Português", tema: "Gramática", pergunta: "A crase é sempre utilizada antes de substantivos femininos.", opcoes: ["Certo", "Errado"], correta: 1 },
                { banca: "FCC", disciplina: "Português", tema: "Interpretação de Texto", pergunta: "Qual a função do sujeito na frase 'O gato correu'?", opcoes: ["Objeto direto", "Sujeito", "Verbo", "Adjetivo", "Advérbio"], correta: 1 },
                { banca: "FCC", disciplina: "Direito Constitucional", tema: "Direitos Fundamentais", pergunta: "Qual artigo da Constituição Federal trata dos direitos e deveres individuais e coletivos?", opcoes: ["Art. 1º", "Art. 3º", "Art. 5º", "Art. 7º", "Art. 10º"], correta: 2 },
                { banca: "CEBRASPE", disciplina: "Informática", tema: "Hardware", pergunta: "RAM é uma memória volátil, ou seja, perde seus dados ao desligar o computador.", opcoes: ["Certo", "Errado"], correta: 0 },
                { banca: "FCC", disciplina: "Matemática", tema: "Geometria", pergunta: "Quantos lados tem um heptágono?", opcoes: ["5", "6", "7", "8", "9"], correta: 2 }
            ],
            estatisticas: {
                disciplinas: {},
                temas: {}
            }
        };

        let quizAtual = {
            perguntas: [],
            indiceAtual: 0,
            acertos: 0,
            erros: 0,
            bancaSelecionadaInfo: null
        };

        let desempenhoDisciplinaChartInstance = null;
        let overallAccuracyChartInstance = null;
        let mostPracticedThemesChartInstance = null;

        const mainContent = document.getElementById('mainContent');
        const sections = {
            questionario: document.getElementById('sectionQuestionario'),
            gerenciar: document.getElementById('sectionGerenciar'),
            estatisticas: document.getElementById('sectionEstatisticas')
        };
        const navButtons = {
            questionario: document.getElementById('navQuestionario'),
            gerenciar: document.getElementById('navGerenciar'),
            estatisticas: document.getElementById('navEstatisticas')
        };

        // Quiz UI Elements
        const quizSetupDiv = document.getElementById('quizSetup');
        const quizAreaDiv = document.getElementById('quizArea');
        const quizResultsDiv = document.getElementById('quizResults');
        const selectModeloProva = document.getElementById('selectModeloProva'); // NEW
        const selectBanca = document.getElementById('selectBanca');
        const temasCheckboxContainer = document.getElementById('temasCheckboxContainer');
        const btnIniciarQuiz = document.getElementById('btnIniciarQuiz');
        const progressLabel = document.getElementById('progressLabel');
        const questionText = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedbackText = document.getElementById('feedbackText');
        const btnConfirmarResposta = document.getElementById('btnConfirmarResposta');
        const btnProximaQuestao = document.getElementById('btnProximaQuestao');
        const resultadoFinalTexto = document.getElementById('resultadoFinalTexto');
        const btnNovoQuestionario = document.getElementById('btnNovoQuestionario');

        // Gerenciar UI Elements - Bancas
        const novaBancaNome = document.getElementById('novaBancaNome');
        const novaBancaNumOpcoes = document.getElementById('novaBancaNumOpcoes');
        const novaBancaDescricao = document.getElementById('novaBancaDescricao');
        const novaBancaPenaliza = document.getElementById('novaBancaPenaliza');
        const btnAdicionarBanca = document.getElementById('btnAdicionarBanca');
        const listaBancasUl = document.getElementById('listaBancas');

        // Gerenciar UI Elements - Disciplinas (NEW)
        const novaDisciplinaNome = document.getElementById('novaDisciplinaNome');
        const novaDisciplinaDescricao = document.getElementById('novaDisciplinaDescricao');
        const btnAdicionarDisciplina = document.getElementById('btnAdicionarDisciplina');
        const listaDisciplinasUl = document.getElementById('listaDisciplinas');

        // Gerenciar UI Elements - Modelos de Prova (NEW)
        const novoModeloNome = document.getElementById('novoModeloNome');
        const selectModeloBanca = document.getElementById('selectModeloBanca');
        const modelosTemasCheckboxContainer = document.getElementById('modelosTemasCheckboxContainer');
        const btnSalvarModeloProva = document.getElementById('btnSalvarModeloProva');
        const listaModelosProvasUl = document.getElementById('listaModelosProvas');

        // Gerenciar UI Elements - Perguntas
        const manualBancaSelect = document.getElementById('manualBancaSelect');
        const manualDisciplinaSelect = document.getElementById('manualDisciplinaSelect'); // Changed to select
        const manualTema = document.getElementById('manualTema');
        const manualPergunta = document.getElementById('manualPergunta');
        const manualOpcoesContainer = document.getElementById('manualOpcoesContainer');
        const manualOpcaoCorretaContainer = document.getElementById('manualOpcaoCorretaContainer');
        const btnSalvarPerguntaManual = document.getElementById('btnSalvarPerguntaManual');
        const csvFileInput = document.getElementById('csvFileInput');
        const btnImportarCSV = document.getElementById('btnImportarCSV');
        const csvImportStatus = document.getElementById('csvImportStatus');

        // Estatisticas UI Elements
        const statsTotalPerguntas = document.getElementById('statsTotalPerguntas');
        const statsTotalAcertos = document.getElementById('statsTotalAcertos');
        const statsTotalErros = document.getElementById('statsTotalErros');
        const statsPorcentagemGeral = document.getElementById('statsPorcentagemGeral');
        const listaDisciplinasEstudo = document.getElementById('listaDisciplinasEstudo');
        const listaTemasEstudo = document.getElementById('listaTemasEstudo');
        const desempenhoDisciplinaChartCtx = document.getElementById('desempenhoDisciplinaChart').getContext('2d');
        const overallAccuracyChartCtx = document.getElementById('overallAccuracyChart').getContext('2d');
        const mostPracticedThemesChartCtx = document.getElementById('mostPracticedThemesChart').getContext('2d');


        // Utility Functions
        function loadDataFromLocalStorage() {
            const storedData = localStorage.getItem('quizAppData');
            if (storedData) {
                const loadedData = JSON.parse(storedData);
                appData.bancas = loadedData.bancas || {};
                appData.perguntas = loadedData.perguntas || [];
                // NEW: Load disciplines and models, ensuring defaults if not present
                appData.disciplinas = loadedData.disciplinas || {};
                appData.modelosProvas = loadedData.modelosProvas || {};
                appData.estatisticas.disciplinas = loadedData.estatisticas?.disciplinas || {};
                appData.estatisticas.temas = loadedData.estatisticas?.temas || {};
            }
        }

        function saveDataToLocalStorage() {
            localStorage.setItem('quizAppData', JSON.stringify(appData));
        }

        function showSection(sectionName) {
            Object.values(sections).forEach(sec => sec.classList.add('hidden'));
            Object.values(navButtons).forEach(btn => btn.classList.remove('active'));
            sections[sectionName].classList.remove('hidden');
            navButtons[sectionName].classList.add('active');
            if (sectionName === 'estatisticas') renderEstatisticas();
            if (sectionName === 'gerenciar') {
                renderListaBancas();
                populateBancaSelect(manualBancaSelect);
                populateBancaSelect(selectModeloBanca); // NEW: For models management
                manualBancaSelect.dispatchEvent(new Event('change')); // Trigger options for manual add
                selectModeloBanca.dispatchEvent(new Event('change')); // NEW: Trigger themes for models
                
                renderListaDisciplinas(); // NEW: Render disciplines list
                populateDisciplinaSelect(manualDisciplinaSelect); // NEW: Populate discipline select
                
                renderListaModelosProvas(); // NEW: Render models list
            }
        }

        function populateBancaSelect(selectElement) {
            selectElement.innerHTML = '<option value="">Selecione uma banca</option>';
            for (const bancaNome in appData.bancas) {
                const option = document.createElement('option');
                option.value = bancaNome;
                option.textContent = bancaNome;
                selectElement.appendChild(option);
            }
        }

        // NEW: Populate Disciplina Select
        function populateDisciplinaSelect(selectElement) {
            selectElement.innerHTML = '<option value="">Selecione uma disciplina</option>';
            const sortedDisciplines = Object.keys(appData.disciplinas).sort();
            sortedDisciplines.forEach(discName => {
                const option = document.createElement('option');
                option.value = discName;
                option.textContent = discName;
                selectElement.appendChild(option);
            });
        }

        // NEW: Populate Modelo Prova Select
        function populateModeloProvaSelect(selectElement) {
            selectElement.innerHTML = '<option value="">Selecione um modelo de prova</option>';
            const sortedModels = Object.keys(appData.modelosProvas).sort();
            sortedModels.forEach(modelName => {
                const option = document.createElement('option');
                option.value = modelName;
                option.textContent = modelName;
                selectElement.appendChild(option);
            });
        }

        // Navigation Logic
        navButtons.questionario.addEventListener('click', () => showSection('questionario'));
        navButtons.gerenciar.addEventListener('click', () => showSection('gerenciar'));
        navButtons.estatisticas.addEventListener('click', () => showSection('estatisticas'));

        // --- Questionário Logic ---
        function carregarBancasNoQuestionario() {
            populateBancaSelect(selectBanca);
            populateModeloProvaSelect(selectModeloProva); // NEW
            selectBanca.addEventListener('change', carregarTemasParaBanca);
            carregarTemasParaBanca(); // Initial call if a banca is pre-selected
        }

        // NEW: Handle Model selection in Quiz Setup
        selectModeloProva.addEventListener('change', () => {
            const modeloNome = selectModeloProva.value;
            if (modeloNome && appData.modelosProvas[modeloNome]) {
                const modelo = appData.modelosProvas[modeloNome];
                selectBanca.value = modelo.banca;
                selectBanca.dispatchEvent(new Event('change')); // Trigger theme load for selected banca
                // Select themes from model
                setTimeout(() => { // Give a moment for themes to load
                    const checkboxes = temasCheckboxContainer.querySelectorAll('input[name="temasQuiz"]');
                    checkboxes.forEach(cb => {
                        cb.checked = modelo.temas.includes(cb.value);
                    });
                }, 50);
            } else {
                // If no model selected or model invalid, clear selections
                selectBanca.value = '';
                selectBanca.dispatchEvent(new Event('change'));
            }
        });

        function carregarTemasParaBanca(container = temasCheckboxContainer) {
            const bancaSelecionada = (container === temasCheckboxContainer) ? selectBanca.value : selectModeloBanca.value;
            container.innerHTML = '';
            if (!bancaSelecionada) {
                container.innerHTML = '<p class="text-gray-500">Selecione uma banca para ver os temas disponíveis.</p>';
                return;
            }

            const temasDaBanca = [...new Set(appData.perguntas
                .filter(p => p.banca === bancaSelecionada)
                .map(p => p.tema))
            ].sort();

            if (temasDaBanca.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nenhum tema disponível para esta banca.</p>';
                return;
            }

            temasDaBanca.forEach(tema => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center', 'mb-1');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `tema-${tema.replace(/\s+/g, '-')}-${container.id}`; // Unique ID for different containers
                checkbox.value = tema;
                checkbox.name = (container === temasCheckboxContainer) ? "temasQuiz" : "temasModelo";
                checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-teal-600');
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = tema;
                label.classList.add('ml-2', 'text-gray-700', 'text-sm');
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        btnIniciarQuiz.addEventListener('click', () => {
            const banca = selectBanca.value;
            const temasSelecionados = Array.from(temasCheckboxContainer.querySelectorAll('input[name="temasQuiz"]:checked')).map(cb => cb.value);

            if (!banca) {
                alert("Por favor, selecione uma banca.");
                return;
            }
            if (temasSelecionados.length === 0) {
                alert("Por favor, selecione pelo menos um tema.");
                return;
            }

            quizAtual.perguntas = appData.perguntas.filter(p => p.banca === banca && temasSelecionados.includes(p.tema));
            if (quizAtual.perguntas.length === 0) {
                alert("Nenhuma pergunta encontrada para os critérios selecionados.");
                return;
            }
            quizAtual.perguntas.sort(() => Math.random() - 0.5); 

            quizAtual.bancaSelecionadaInfo = appData.bancas[banca];
            quizAtual.indiceAtual = 0;
            quizAtual.acertos = 0;
            quizAtual.erros = 0;

            quizSetupDiv.classList.add('hidden');
            quizAreaDiv.classList.remove('hidden');
            quizResultsDiv.classList.add('hidden');
            mostrarProximaQuestao();
        });

        function mostrarProximaQuestao() {
            if (quizAtual.indiceAtual >= quizAtual.perguntas.length) {
                mostrarResultadoQuiz();
                return;
            }

            const pergunta = quizAtual.perguntas[quizAtual.indiceAtual];
            progressLabel.textContent = `Questão ${quizAtual.indiceAtual + 1} de ${quizAtual.perguntas.length}`;
            questionText.textContent = pergunta.pergunta;
            optionsContainer.innerHTML = '';
            feedbackText.textContent = '';
            btnConfirmarResposta.classList.remove('hidden');
            btnProximaQuestao.classList.add('hidden');

            pergunta.opcoes.forEach((opcao, index) => {
                const div = document.createElement('div');
                div.classList.add('p-2', 'border', 'rounded-md', 'hover:bg-gray-100', 'cursor-pointer');
                
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'opcaoResposta';
                radio.value = index;
                radio.id = `opcao-${index}`;
                radio.classList.add('mr-2');

                const label = document.createElement('label');
                label.htmlFor = `opcao-${index}`;
                label.textContent = opcao;
                label.classList.add('cursor-pointer', 'w-full', 'block');
                
                div.appendChild(radio);
                div.appendChild(label);
                div.addEventListener('click', () => { radio.checked = true; });
                optionsContainer.appendChild(div);
            });
        }

        btnConfirmarResposta.addEventListener('click', () => {
            const respostaSelecionada = optionsContainer.querySelector('input[name="opcaoResposta"]:checked');
            if (!respostaSelecionada) {
                alert("Por favor, selecione uma resposta.");
                return;
            }

            const perguntaAtual = quizAtual.perguntas[quizAtual.indiceAtual];
            const indiceResposta = parseInt(respostaSelecionada.value);
            const disciplina = perguntaAtual.disciplina;
            const tema = perguntaAtual.tema;

            if (!appData.estatisticas.disciplinas[disciplina]) {
                appData.estatisticas.disciplinas[disciplina] = { acertos: 0, erros: 0, total: 0 };
            }
            appData.estatisticas.disciplinas[disciplina].total++;

            if (!appData.estatisticas.temas[tema]) {
                appData.estatisticas.temas[tema] = { acertos: 0, erros: 0, total: 0 };
            }
            appData.estatisticas.temas[tema].total++;

            if (indiceResposta === perguntaAtual.correta) {
                quizAtual.acertos++;
                appData.estatisticas.disciplinas[disciplina].acertos++;
                appData.estatisticas.temas[tema].acertos++;
                feedbackText.textContent = "Correto!";
                feedbackText.className = "text-lg font-medium my-3 text-green-600";
            } else {
                quizAtual.erros++;
                appData.estatisticas.disciplinas[disciplina].erros++;
                appData.estatisticas.temas[tema].erros++;
                feedbackText.textContent = `Errado. A resposta correta era: ${perguntaAtual.opcoes[perguntaAtual.correta]}`;
                feedbackText.className = "text-lg font-medium my-3 text-red-600";
                if (quizAtual.bancaSelecionadaInfo && quizAtual.bancaSelecionadaInfo.penaliza_erro) {
                    feedbackText.textContent += " (Esta banca penaliza erros)";
                }
            }
            saveDataToLocalStorage();
            btnConfirmarResposta.classList.add('hidden');
            btnProximaQuestao.classList.remove('hidden');
        });

        btnProximaQuestao.addEventListener('click', () => {
            quizAtual.indiceAtual++;
            mostrarProximaQuestao();
        });

        function mostrarResultadoQuiz() {
            quizAreaDiv.classList.add('hidden');
            quizResultsDiv.classList.remove('hidden');
            const totalPerguntas = quizAtual.perguntas.length;
            const porcentagem = totalPerguntas > 0 ? (quizAtual.acertos / totalPerguntas * 100).toFixed(2) : 0;
            resultadoFinalTexto.innerHTML = `
                Você acertou ${quizAtual.acertos} de ${totalPerguntas} perguntas.<br>
                Erros: ${quizAtual.erros}.<br>
                Sua porcentagem de acerto foi de ${porcentagem}%.
            `;
        }
        
        btnNovoQuestionario.addEventListener('click', () => {
            quizSetupDiv.classList.remove('hidden');
            quizAreaDiv.classList.add('hidden');
            quizResultsDiv.classList.add('hidden');
            carregarTemasParaBanca(); // Reset themes based on current banca
            selectModeloProva.value = ''; // Clear selected model
        });

        // --- Gerenciar Conteúdo Logic ---

        // Bancas Logic
        btnAdicionarBanca.addEventListener('click', () => {
            const nome = novaBancaNome.value.trim();
            const numOpcoes = parseInt(novaBancaNumOpcoes.value);
            const descricao = novaBancaDescricao.value.trim();
            const penaliza = novaBancaPenaliza.checked;

            if (!nome || isNaN(numOpcoes) || numOpcoes < 2) {
                alert("Nome da banca e número de opções (mínimo 2) são obrigatórios.");
                return;
            }
            if (appData.bancas[nome]) {
                alert("Uma banca com este nome já existe.");
                return;
            }
            appData.bancas[nome] = { num_opcoes: numOpcoes, descricao: descricao, penaliza_erro: penaliza };
            saveDataToLocalStorage();
            alert(`Banca "${nome}" adicionada com sucesso!`);
            novaBancaNome.value = '';
            novaBancaNumOpcoes.value = '5';
            novaBancaDescricao.value = '';
            novaBancaPenaliza.checked = false;
            renderListaBancas();
            populateBancaSelect(manualBancaSelect);
            populateBancaSelect(selectBanca);
            populateBancaSelect(selectModeloBanca); // NEW
        });

        function renderListaBancas() {
            listaBancasUl.innerHTML = '';
            if (Object.keys(appData.bancas).length === 0) {
                 listaBancasUl.innerHTML = '<li class="text-gray-500">Nenhuma banca cadastrada.</li>';
                 return;
            }
            for (const nomeBanca in appData.bancas) {
                const info = appData.bancas[nomeBanca];
                const li = document.createElement('li');
                li.textContent = `${nomeBanca} (${info.num_opcoes} opções) - ${info.descricao || 'Sem descrição'}${info.penaliza_erro ? ' (Penaliza Erro)' : ''}`;
                li.classList.add('text-sm', 'text-gray-700', 'py-1');
                listaBancasUl.appendChild(li);
            }
        }
        
        // NEW: Disciplinas Logic
        btnAdicionarDisciplina.addEventListener('click', () => {
            const nome = novaDisciplinaNome.value.trim();
            const descricao = novaDisciplinaDescricao.value.trim();

            if (!nome) {
                alert("Nome da disciplina é obrigatório.");
                return;
            }
            if (appData.disciplinas[nome]) {
                alert("Uma disciplina com este nome já existe.");
                return;
            }
            appData.disciplinas[nome] = { descricao: descricao };
            saveDataToLocalStorage();
            alert(`Disciplina "${nome}" adicionada com sucesso!`);
            novaDisciplinaNome.value = '';
            novaDisciplinaDescricao.value = '';
            renderListaDisciplinas();
            populateDisciplinaSelect(manualDisciplinaSelect); // Update the select dropdown
        });

        function renderListaDisciplinas() {
            listaDisciplinasUl.innerHTML = '';
            if (Object.keys(appData.disciplinas).length === 0) {
                listaDisciplinasUl.innerHTML = '<li class="text-gray-500">Nenhuma disciplina cadastrada.</li>';
                return;
            }
            const sortedDisciplines = Object.keys(appData.disciplinas).sort();
            sortedDisciplines.forEach(discName => {
                const info = appData.disciplinas[discName];
                const li = document.createElement('li');
                li.textContent = `${discName} - ${info.descricao || 'Sem descrição'}`;
                li.classList.add('text-sm', 'text-gray-700', 'py-1');
                listaDisciplinasUl.appendChild(li);
            });
        }

        // NEW: Modelos de Prova Logic
        selectModeloBanca.addEventListener('change', () => {
            carregarTemasParaBanca(modelosTemasCheckboxContainer); // Reuse function with specific container
        });

        btnSalvarModeloProva.addEventListener('click', () => {
            const nomeModelo = novoModeloNome.value.trim();
            const bancaModelo = selectModeloBanca.value;
            const temasModelo = Array.from(modelosTemasCheckboxContainer.querySelectorAll('input[name="temasModelo"]:checked')).map(cb => cb.value);

            if (!nomeModelo || !bancaModelo || temasModelo.length === 0) {
                alert("Nome do modelo, banca e pelo menos um tema são obrigatórios.");
                return;
            }
            if (appData.modelosProvas[nomeModelo]) {
                alert("Um modelo de prova com este nome já existe.");
                return;
            }

            appData.modelosProvas[nomeModelo] = { banca: bancaModelo, temas: temasModelo };
            saveDataToLocalStorage();
            alert(`Modelo de prova "${nomeModelo}" salvo com sucesso!`);
            novoModeloNome.value = '';
            selectModeloBanca.value = '';
            selectModeloBanca.dispatchEvent(new Event('change')); // Clear themes checkbox
            renderListaModelosProvas();
            populateModeloProvaSelect(selectModeloProva); // Update quiz section dropdown
        });

        function renderListaModelosProvas() {
            listaModelosProvasUl.innerHTML = '';
            if (Object.keys(appData.modelosProvas).length === 0) {
                listaModelosProvasUl.innerHTML = '<li class="text-gray-500">Nenhum modelo de prova cadastrado.</li>';
                return;
            }
            const sortedModels = Object.keys(appData.modelosProvas).sort();
            sortedModels.forEach(modelName => {
                const model = appData.modelosProvas[modelName];
                const li = document.createElement('li');
                li.textContent = `${modelName} - Banca: ${model.banca}, Temas: ${model.temas.join(', ')}`;
                li.classList.add('text-sm', 'text-gray-700', 'py-1');
                listaModelosProvasUl.appendChild(li);
            });
        }

        // Pergunta Manual Logic
        manualBancaSelect.addEventListener('change', () => {
            const nomeBanca = manualBancaSelect.value;
            manualOpcoesContainer.innerHTML = '';
            manualOpcaoCorretaContainer.innerHTML = '';
            if (!nomeBanca || !appData.bancas[nomeBanca]) return;

            const numOpcoes = appData.bancas[nomeBanca].num_opcoes;
            for (let i = 0; i < numOpcoes; i++) {
                const labelText = (nomeBanca === "CEBRASPE" && numOpcoes === 2) ? (i === 0 ? "Certo" : "Errado") : `Opção ${String.fromCharCode(65 + i)}`;
                
                const opLabel = document.createElement('label');
                opLabel.textContent = `${labelText}:`;
                opLabel.htmlFor = `manualOpcao${i}`;
                opLabel.classList.add('block', 'text-sm', 'font-medium', 'text-gray-700', 'mt-2');
                manualOpcoesContainer.appendChild(opLabel);

                const input = document.createElement('input');
                input.type = 'text';
                input.id = `manualOpcao${i}`;
                input.classList.add('form-input', 'mb-1');
                if (nomeBanca === "CEBRASPE" && numOpcoes === 2) {
                    input.value = (i === 0 ? "Certo" : "Errado");
                    input.readOnly = true;
                }
                manualOpcoesContainer.appendChild(input);

                const radioDiv = document.createElement('div');
                radioDiv.classList.add('flex', 'items-center', 'mb-1');
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'manualOpcaoCorreta';
                radio.value = i;
                radio.id = `manualCorreta${i}`;
                radio.classList.add('form-radio');
                
                const radioLabel = document.createElement('label');
                radioLabel.htmlFor = `manualCorreta${i}`;
                radioLabel.textContent = `Marcar ${labelText} como correta`;
                radioLabel.classList.add('ml-2', 'text-sm', 'text-gray-700');
                
                radioDiv.appendChild(radio);
                radioDiv.appendChild(radioLabel);
                manualOpcaoCorretaContainer.appendChild(radioDiv);
            }
        });

        btnSalvarPerguntaManual.addEventListener('click', () => {
            const banca = manualBancaSelect.value;
            const disciplina = manualDisciplinaSelect.value; // Get from select
            const tema = manualTema.value.trim();
            const pergunta = manualPergunta.value.trim();
            
            if (!banca || !disciplina || !tema || !pergunta) {
                alert("Todos os campos (Banca, Disciplina, Tema, Pergunta) são obrigatórios.");
                return;
            }

            const opcoesInputs = manualOpcoesContainer.querySelectorAll('input[type="text"]');
            const opcoes = Array.from(opcoesInputs).map(input => input.value.trim());
            if (opcoes.some(op => op === '')) {
                alert("Todas as opções devem ser preenchidas.");
                return;
            }

            const corretaRadio = manualOpcaoCorretaContainer.querySelector('input[name="manualOpcaoCorreta"]:checked');
            if (!corretaRadio) {
                alert("Selecione a opção correta.");
                return;
            }
            const correta = parseInt(corretaRadio.value);

            appData.perguntas.push({ banca, disciplina, tema, pergunta, opcoes, correta });
            saveDataToLocalStorage();
            alert("Pergunta salva com sucesso!");
            manualBancaSelect.value = ''; // Clear banca
            manualDisciplinaSelect.value = ''; // Clear disciplina
            manualTema.value = '';
            manualPergunta.value = '';
            manualBancaSelect.dispatchEvent(new Event('change')); // Reset options and correct choice
            carregarTemasParaBanca(); // Update themes in quiz section
            selectModeloBanca.dispatchEvent(new Event('change')); // NEW: Update themes for models in manage section
        });

        btnImportarCSV.addEventListener('click', () => {
            const file = csvFileInput.files[0];
            if (!file) {
                csvImportStatus.textContent = "Por favor, selecione um arquivo CSV.";
                csvImportStatus.className = "text-sm mt-2 text-red-600";
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const csvData = event.target.result;
                try {
                    const lines = csvData.split(/\r\n|\n/);
                    const headers = lines[0].split(',').map(h => h.trim());
                    let perguntasImportadas = 0;
                    let errosImportacao = [];

                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim() === '') continue;
                        const data = lines[i].split(',');
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = data[index] ? data[index].trim() : '';
                        });

                        const { banca, disciplina, tema, pergunta } = row;
                        const correta = parseInt(row.correta);

                        if (!banca || !disciplina || !tema || !pergunta || isNaN(correta)) {
                            errosImportacao.push(`Linha ${i+1}: Dados incompletos ou formato incorreto.`);
                            continue;
                        }
                        if (!appData.bancas[banca]) {
                            errosImportacao.push(`Linha ${i+1}: Banca "${banca}" não cadastrada.`);
                            continue;
                        }

                        // NEW: Add discipline if it doesn't exist
                        if (!appData.disciplinas[disciplina]) {
                            appData.disciplinas[disciplina] = { descricao: "Adicionada via CSV" };
                            console.log(`Nova disciplina "${disciplina}" adicionada via CSV.`);
                        }

                        const numOpcoesEsperado = appData.bancas[banca].num_opcoes;
                        const opcoes = [];
                        for (let j = 1; j <= numOpcoesEsperado; j++) {
                            if (row[`opcao${j}`]) {
                                opcoes.push(row[`opcao${j}`]);
                            } else {
                                break;
                            }
                        }

                        if (opcoes.length !== numOpcoesEsperado) {
                             errosImportacao.push(`Linha ${i+1}: Número de opções (${opcoes.length}) não corresponde ao esperado para a banca "${banca}" (${numOpcoesEsperado}).`);
                            continue;
                        }
                         if (correta < 0 || correta >= opcoes.length) {
                            errosImportacao.push(`Linha ${i+1}: Índice da resposta correta (${correta}) inválido.`);
                            continue;
                        }


                        appData.perguntas.push({ banca, disciplina, tema, pergunta, opcoes, correta });
                        perguntasImportadas++;
                    }
                    saveDataToLocalStorage();
                    csvImportStatus.textContent = `${perguntasImportadas} perguntas importadas.`;
                    if (errosImportacao.length > 0) {
                        csvImportStatus.textContent += ` ${errosImportacao.length} erros: ${errosImportacao.slice(0,2).join('; ')}... (ver console para detalhes)`;
                        console.warn("Erros na importação CSV:", errosImportacao);
                    }
                    csvImportStatus.className = "text-sm mt-2 text-green-600";
                    csvFileInput.value = '';
                    carregarTemasParaBanca(); // Update themes in quiz section
                    renderListaDisciplinas(); // NEW: Refresh disciplines list
                    populateDisciplinaSelect(manualDisciplinaSelect); // NEW: Refresh discipline select
                    selectModeloBanca.dispatchEvent(new Event('change')); // NEW: Refresh themes for models in manage section
                } catch (error) {
                    csvImportStatus.textContent = "Erro ao processar o arquivo CSV. Verifique o formato.";
                    csvImportStatus.className = "text-sm mt-2 text-red-600";
                    console.error("Erro CSV:", error);
                }
            };
            reader.readAsText(file);
        });


        // --- Estatísticas Logic ---
        function renderEstatisticas() {
            let totalPerguntasGlobal = 0;
            let totalAcertosGlobal = 0;
            let totalErrosGlobal = 0;
            const desempenhoDisciplinas = appData.estatisticas.disciplinas;
            const desempenhoTemas = appData.estatisticas.temas;

            for (const discNome in desempenhoDisciplinas) {
                const stats = desempenhoDisciplinas[discNome];
                totalAcertosGlobal += stats.acertos;
                totalErrosGlobal += stats.erros;
                totalPerguntasGlobal += stats.total;
            }

            statsTotalPerguntas.textContent = `Total de Perguntas Respondidas: ${totalPerguntasGlobal}`;
            statsTotalAcertos.textContent = `Total de Acertos: ${totalAcertosGlobal}`;
            statsTotalErros.textContent = `Total de Erros: ${totalErrosGlobal}`;
            const porcentagemGeral = totalPerguntasGlobal > 0 ? (totalAcertosGlobal / totalPerguntasGlobal * 100).toFixed(2) : 0;
            statsPorcentagemGeral.textContent = `Porcentagem Geral de Acertos: ${porcentagemGeral}%`;

            renderOverallAccuracyChart(totalAcertosGlobal, totalErrosGlobal);
            renderDesempenhoDisciplinaChart(desempenhoDisciplinas);
            renderMostPracticedThemesChart(desempenhoTemas);
            renderDisciplinesNeedingStudyList(desempenhoDisciplinas);
            renderThemesNeedingStudyList(desempenhoTemas);
        }

        function renderOverallAccuracyChart(acertos, erros) {
            if (overallAccuracyChartInstance) {
                overallAccuracyChartInstance.destroy();
            }

            const total = acertos + erros;
            if (total === 0) {
                overallAccuracyChartCtx.clearRect(0, 0, overallAccuracyChartCtx.canvas.width, overallAccuracyChartCtx.canvas.height);
                overallAccuracyChartCtx.textAlign = 'center';
                overallAccuracyChartCtx.fillText('Nenhum dado para exibir.', overallAccuracyChartCtx.canvas.width / 2, overallAccuracyChartCtx.canvas.height / 2);
                return;
            }

            overallAccuracyChartInstance = new Chart(overallAccuracyChartCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Acertos', 'Erros'],
                    datasets: [{
                        data: [acertos, erros],
                        backgroundColor: ['rgba(75, 192, 192, 0.8)', 'rgba(255, 99, 132, 0.8)'],
                        borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = (value / total * 100).toFixed(2);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDesempenhoDisciplinaChart(data) {
            const labels = Object.keys(data);
            const acertosData = labels.map(l => data[l].acertos);
            const errosData = labels.map(l => data[l].erros);

            if (desempenhoDisciplinaChartInstance) {
                desempenhoDisciplinaChartInstance.destroy();
            }

            if (labels.length === 0) {
                 desempenhoDisciplinaChartCtx.clearRect(0, 0, desempenhoDisciplinaChartCtx.canvas.width, desempenhoDisciplinaChartCtx.canvas.height);
                 desempenhoDisciplinaChartCtx.textAlign = 'center';
                 desempenhoDisciplinaChartCtx.fillText('Nenhum dado para exibir no gráfico.', desempenhoDisciplinaChartCtx.canvas.width / 2, desempenhoDisciplinaChartCtx.canvas.height / 2);
                 return;
            }

            desempenhoDisciplinaChartInstance = new Chart(desempenhoDisciplinaChartCtx, {
                type: 'bar',
                data: {
                    labels: labels.map(label => label.length > 16 ? label.substring(0, 13) + '...' : label),
                    datasets: [
                        {
                            label: 'Acertos',
                            data: acertosData,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Erros',
                            data: errosData,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } },
                        x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) { label += context.parsed.y; }
                                    const originalLabel = labels[context.dataIndex];
                                    if (originalLabel.length > 16) {
                                        label += ` (${originalLabel})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderMostPracticedThemesChart(data) {
            const themesData = Object.entries(data)
                .filter(([_, stats]) => stats.total > 0)
                .map(([theme, stats]) => ({ theme, total: stats.total }))
                .sort((a, b) => b.total - a.total);

            const labels = themesData.map(d => d.theme);
            const totalAttempts = themesData.map(d => d.total);

            if (mostPracticedThemesChartInstance) {
                mostPracticedThemesChartInstance.destroy();
            }

            if (labels.length === 0) {
                 mostPracticedThemesChartCtx.clearRect(0, 0, mostPracticedThemesChartCtx.canvas.width, mostPracticedThemesChartCtx.canvas.height);
                 mostPracticedThemesChartCtx.textAlign = 'center';
                 mostPracticedThemesChartCtx.fillText('Nenhum dado para exibir no gráfico.', mostPracticedThemesChartCtx.canvas.width / 2, mostPracticedThemesChartCtx.canvas.height / 2);
                 return;
            }

            mostPracticedThemesChartInstance = new Chart(mostPracticedThemesChartCtx, {
                type: 'bar',
                data: {
                    labels: labels.map(label => label.length > 16 ? label.substring(0, 13) + '...' : label),
                    datasets: [{
                        label: 'Total de Práticas',
                        data: totalAttempts,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } },
                        x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) { label += context.parsed.y; }
                                    const originalLabel = labels[context.dataIndex];
                                    if (originalLabel.length > 16) {
                                        label += ` (${originalLabel})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDisciplinesNeedingStudyList(data) {
            const needsStudyDisciplines = Object.entries(data)
                .filter(([_, stats]) => stats.total > 0)
                .map(([name, stats]) => ({
                    name,
                    errorRate: stats.total > 0 ? (stats.erros / stats.total) : 0,
                    erros: stats.erros,
                    total: stats.total
                }))
                .sort((a, b) => b.errorRate - a.errorRate || b.erros - a.erros);

            listaDisciplinasEstudo.innerHTML = '';
            if (needsStudyDisciplines.length > 0) {
                needsStudyDisciplines.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.name}: ${(item.errorRate * 100).toFixed(2)}% de erros (${item.erros}/${item.total})`;
                    li.classList.add('text-sm', 'py-1');
                    if (item.errorRate > 0.5 && item.total >= 5) {
                        li.classList.add('text-red-600', 'font-semibold');
                    } else if (item.errorRate > 0.3 && item.total >= 3) {
                        li.classList.add('text-orange-500');
                    }
                    listaDisciplinasEstudo.appendChild(li);
                });
            } else {
                listaDisciplinasEstudo.innerHTML = '<li class="text-gray-500">Nenhum dado disponível.</li>';
            }
        }

        function renderThemesNeedingStudyList(data) {
            const needsStudyThemes = Object.entries(data)
                .filter(([_, stats]) => stats.total > 0)
                .map(([name, stats]) => ({
                    name,
                    errorRate: stats.total > 0 ? (stats.erros / stats.total) : 0,
                    erros: stats.erros,
                    total: stats.total
                }))
                .sort((a, b) => b.errorRate - a.errorRate || b.erros - a.erros);

            listaTemasEstudo.innerHTML = '';
            if (needsStudyThemes.length > 0) {
                needsStudyThemes.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.name}: ${(item.errorRate * 100).toFixed(2)}% de erros (${item.erros}/${item.total})`;
                    li.classList.add('text-sm', 'py-1');
                    if (item.errorRate > 0.5 && item.total >= 5) {
                        li.classList.add('text-red-600', 'font-semibold');
                    } else if (item.errorRate > 0.3 && item.total >= 3) {
                        li.classList.add('text-orange-500');
                    }
                    listaTemasEstudo.appendChild(li);
                });
            } else {
                listaTemasEstudo.innerHTML = '<li class="text-gray-500">Nenhum dado disponível.</li>';
            }
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocalStorage();
            showSection('questionario'); // Default section
            carregarBancasNoQuestionario();
            document.getElementById('currentYear').textContent = new Date().getFullYear();
        });

    </script>
</body>
</html>
